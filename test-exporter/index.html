<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test exporter - Noat Boat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f2f2f2; color: #111; height: 100vh; display: flex; flex-direction: column; }
    .topbar { display: flex; align-items: center; padding: 10px 14px; border-bottom: 1px solid #d9d9d9; background: #ffffff; gap: 12px; }
    .back-btn { padding: 6px 12px; border: 1px solid #d9d9d9; background: #ffffff; border-radius: 6px; cursor: pointer; font-size: 13px; color: #111; text-decoration: none; }
    .title { font-size: 16px; font-weight: 700; font-family: monospace; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .save-status { font-size: 12px; color: #666; font-family: monospace; }
    .main { display: flex; flex: 1; overflow: hidden; gap: 16px; padding: 14px; min-height: 0; }
    .editor-pane { flex: 1; display: flex; flex-direction: column; min-width: 200px; min-height: 0; }
    textarea { flex: 1; border: 1px solid #d9d9d9; border-radius: 12px; resize: none; padding: 14px; font-size: 14px; line-height: 1.55; font-family: monospace; background: #fff; color: #111; outline: none; }
    .canvas-pane { flex: 1; display: flex; flex-direction: column; min-width: 200px; min-height: 0; border: 1px solid #d9d9d9; border-radius: 12px; overflow: hidden; background: #fff; }
    .canvas-toolbar { display: flex; gap: 6px; padding: 8px 10px; border-bottom: 1px solid #d9d9d9; background: #ffffff; flex-shrink: 0; }
    .btn { padding: 5px 10px; border: 1px solid #d9d9d9; background: #ffffff; border-radius: 6px; cursor: pointer; font-size: 12px; color: #111; }
    .btn.active { background: #eef5ff; border-color: #c9dcff; }
    #canvasContainer { flex: 1; position: relative; overflow: hidden; min-height: 0; display: flex; align-items: center; justify-content: center; }
    .canvas-wrapper { transform-origin: center center; display: inline-block; }
    .audio-player { padding: 10px; border-top: 1px solid #d9d9d9; display: none; flex-shrink: 0; }
    .audio-player audio { width: 100%; }
    @media (max-width: 768px) { .main { flex-direction: column; } .editor-pane, .canvas-pane { flex: none; height: 45vh; } }
  </style>
</head>
<body>
  <div class="topbar">
    <a href="../index.html" class="back-btn">Back</a>
    <div class="title">Test exporter</div>
    <div class="save-status" id="saveStatus"></div>
  </div>
  <div class="main">
    <div class="editor-pane">
      <textarea id="editor" spellcheck="false">This is a test export bread</textarea>
    </div>
    <div class="canvas-pane" id="canvasPane">
      <div class="canvas-toolbar">
        <button id="selectBtn" class="btn active">Select</button>
        <button id="drawBtn" class="btn">Draw</button>
      </div>
      <div id="canvasContainer">
        <div class="canvas-wrapper" id="canvasWrapper">
          <canvas id="fabricCanvas"></canvas>
        </div>
      </div>
      <div class="audio-player"><audio controls loop src=""></audio></div>
    </div>
  </div>
  <script>
    (function() {
      var STORAGE_KEY = 'noatboat_' + "test-exporter";
      var canvasJson = "{\"version\":\"5.3.0\",\"objects\":[{\"type\":\"path\",\"version\":\"5.3.0\",\"originX\":\"left\",\"originY\":\"top\",\"left\":246.42,\"top\":273.46,\"width\":863.67,\"height\":1009.86,\"fill\":null,\"stroke\":\"#000000\",\"strokeWidth\":3,\"strokeDashArray\":null,\"strokeLineCap\":\"round\",\"strokeDashOffset\":0,\"strokeLineJoin\":\"round\",\"strokeUniform\":false,\"strokeMiterLimit\":10,\"scaleX\":1,\"scaleY\":1,\"angle\":0,\"flipX\":false,\"flipY\":false,\"opacity\":1,\"shadow\":null,\"visible\":true,\"backgroundColor\":\"\",\"fillRule\":\"nonzero\",\"paintFirst\":\"fill\",\"globalCompositeOperation\":\"source-over\",\"skewX\":0,\"skewY\":0,\"selectable\":true,\"hasControls\":true,\"path\":[[\"M\",647.7931416007652,274.9583496923698],[\"Q\",647.7901416007652,274.9583496923698,648.7904448643479,274.9583496923698],[\"Q\",649.7907481279307,274.9583496923698,645.7895350735998,274.9583496923698],[\"Q\",641.7883220192689,274.9583496923698,631.7852893834418,276.9589561476121],[\"Q\",621.7822567476147,278.9595626028545,598.7752816852123,290.96320133430856],[\"Q\",575.7683066228101,302.96684006576265,539.7573891338326,324.9735110734284],[\"Q\",503.74647164485503,346.9801820810942,462.73403783796397,376.98927890972936],[\"Q\",421.7216040310729,406.9983757383646,386.7109898056781,438.0077757946209],[\"Q\",351.7003755802832,469.01717585087727,325.69249072713274,500.02657590713363],[\"Q\",299.6846058739823,531.03597596339,281.6791471294936,564.0459824748887],[\"Q\",263.6736883850048,597.0559889863873,256.67156553992584,624.064176132159],[\"Q\",249.66944269484688,651.0723632779307,248.66913943126417,674.0793375132176],[\"Q\",247.66883616768146,697.0863117485046,248.66913943126417,712.0908601628222],[\"Q\",249.66944269484688,727.0954085771398,251.6700492220123,735.0978343981092],[\"Q\",253.6706557491777,743.1002602190786,257.6718688035086,746.1011699019421],[\"Q\",261.6730818578394,749.1020795848056,262.67338512142214,750.1023828124268],[\"Q\",263.6736883850048,751.102686040048,266.674598175753,756.1042021781539],[\"Q\",269.6755079665011,761.1057183162596,281.6791471294936,779.1111764134407],[\"Q\",293.68278629248607,797.1166345106219,316.6897613548884,829.1263377944995],[\"Q\",339.6967364172907,861.1360410783769,382.70977675134725,916.1527185975415],[\"Q\",425.72281708540373,971.1693961167059,487.74161942753176,1040.190318822567],[\"Q\",549.7604217696597,1109.2112415284278,602.7764947395433,1158.2260996818652],[\"Q\",655.7925677094269,1207.2409578353027,688.8025754076563,1231.2482352982106],[\"Q\",721.8125831058857,1255.2555127611188,742.8189516411226,1266.2588482649517],[\"Q\",763.8253201763595,1277.2621837687846,773.8283528121865,1281.2633966792691],[\"Q\",783.8313854480136,1285.264609589754,785.8319919751791,1284.2643063621329],[\"Q\",787.8325985023445,1283.2640031345118,793.8344180838408,1280.2630934516483],[\"Q\",799.8362376653371,1277.2621837687846,810.8395735647468,1271.2603644030576],[\"Q\",821.8429094641566,1265.2585450373306,833.8465486271491,1255.255512761119],[\"Q\",845.8501877901416,1245.2524804849072,863.8556465346304,1231.2482352982106],[\"Q\",881.8611052791192,1217.2439901115142,905.8683836051042,1196.2376223314695],[\"Q\",929.8756619310892,1175.231254551425,954.883243520657,1153.2245835437593],[\"Q\",979.8908251102247,1131.2179125360935,1001.8974969090443,1111.21184798367],[\"Q\",1023.904168707864,1091.2057834312466,1042.9099307159354,1071.1997188788232],[\"Q\",1061.915692724007,1051.1936543263996,1074.919635150582,1031.1875897739762],[\"Q\",1087.9235775771574,1011.1815252215528,1094.9257004222363,991.1754606691293],[\"Q\",1101.9278232673153,971.1693961167059,1104.9287330580632,947.1621186537977],[\"Q\",1107.9296428488115,923.1548411908896,1109.930249375977,893.1457443622544],[\"Q\",1111.9308559031424,863.1366475336192,1110.9305526395597,829.1263377944994],[\"Q\",1109.930249375977,795.1160280553795,1107.9296428488115,759.1051118610173],[\"Q\",1105.9290363216462,723.0941956666551,1100.9275200037328,688.083582699914],[\"Q\",1095.926003685819,653.072969733173,1088.92388084074,623.0638729045378],[\"Q\",1081.921757995661,593.0547760759026,1074.919635150582,568.0471953853732],[\"Q\",1067.9175123055031,543.039614694844,1061.915692724007,525.0341565976629],[\"Q\",1055.9138731425107,507.0286985004818,1050.9123568245973,492.02415008616424],[\"Q\",1045.9108405066836,477.01960167184666,1042.9099307159354,465.01596294039257],[\"Q\",1039.9090209251872,453.0123242089385,1036.908111134439,444.00959516034794],[\"Q\",1033.907201343691,435.0068661117574,1031.9065948165257,427.004440290788],[\"Q\",1029.9059882893603,419.0020144698186,1026.905078498612,414.0004983317128],[\"Q\",1023.904168707864,408.99898219360693,1018.9026523899504,403.99746605550104],[\"Q\",1013.9011360720368,398.9959499173952,1006.8990132269578,393.99443377928935],[\"Q\",999.8968903818788,388.99291764118345,989.8938577460517,383.99140150307755],[\"Q\",979.8908251102247,378.9898853649717,965.8865794200667,373.98836922686587],[\"Q\",951.8823337299089,368.98685308876003,935.8774815125855,363.9853369506542],[\"Q\",919.8726292952622,358.9838208125483,900.8668672871906,355.9829111296848],[\"Q\",881.8611052791192,352.98200144682124,855.8532204259687,349.9810917639577],[\"Q\",829.8453355728183,346.9801820810942,797.8356311381716,345.979878853473],[\"Q\",765.8259267035249,344.97957562585185,729.8150092145474,344.97957562585185],[\"Q\",693.8040917255698,344.97957562585185,662.7946905545059,344.97957562585185],[\"Q\",631.7852893834419,344.97957562585185,608.7783143210395,344.97957562585185],[\"Q\",585.7713392586372,344.97957562585185,569.7664870413139,344.97957562585185],[\"Q\",553.7616348239906,344.97957562585185,546.7595119789116,344.97957562585185],[\"Q\",539.7573891338326,344.97957562585185,537.7567826066672,345.979878853473],[\"Q\",535.7561760795018,346.9801820810942,535.7561760795018,354.9826079020636],[\"L\",535.7561760795018,362.98803372303297]]},{\"type\":\"path\",\"version\":\"5.3.0\",\"originX\":\"left\",\"originY\":\"top\",\"left\":472.23,\"top\":547.54,\"width\":184.06,\"height\":0,\"fill\":null,\"stroke\":\"#000000\",\"strokeWidth\":3,\"strokeDashArray\":null,\"strokeLineCap\":\"round\",\"strokeDashOffset\":0,\"strokeLineJoin\":\"round\",\"strokeUniform\":false,\"strokeMiterLimit\":10,\"scaleX\":1,\"scaleY\":1,\"angle\":0,\"flipX\":false,\"flipY\":false,\"opacity\":1,\"shadow\":null,\"visible\":true,\"backgroundColor\":\"\",\"fillRule\":\"nonzero\",\"paintFirst\":\"fill\",\"globalCompositeOperation\":\"source-over\",\"skewX\":0,\"skewY\":0,\"selectable\":true,\"hasControls\":true,\"path\":[[\"M\",473.7343737373738,549.0414340605711],[\"Q\",473.7373737373738,549.0414340605711,474.7376770009565,549.0414340605711],[\"Q\",475.7379802645392,549.0414340605711,493.74343900902795,549.0414340605711],[\"Q\",511.7488977535167,549.0414340605711,532.7552662887537,549.0414340605711],[\"Q\",553.7616348239906,549.0414340605711,574.7680033592275,549.0414340605711],[\"Q\",595.7743718944644,549.0414340605711,610.778920848205,549.0414340605711],[\"Q\",625.7834698019456,549.0414340605711,635.7865024377727,549.0414340605711],[\"Q\",645.7895350735998,549.0414340605711,651.791354655096,549.0414340605711],[\"L\",657.7961742365924,549.0414340605711]]},{\"type\":\"path\",\"version\":\"5.3.0\",\"originX\":\"left\",\"originY\":\"top\",\"left\":841.38,\"top\":545.54,\"width\":167.02,\"height\":2,\"fill\":null,\"stroke\":\"#000000\",\"strokeWidth\":3,\"strokeDashArray\":null,\"strokeLineCap\":\"round\",\"strokeDashOffset\":0,\"strokeLineJoin\":\"round\",\"strokeUniform\":false,\"strokeMiterLimit\":10,\"scaleX\":1,\"scaleY\":1,\"angle\":0,\"flipX\":false,\"flipY\":false,\"opacity\":1,\"shadow\":null,\"visible\":true,\"backgroundColor\":\"\",\"fillRule\":\"nonzero\",\"paintFirst\":\"fill\",\"globalCompositeOperation\":\"source-over\",\"skewX\":0,\"skewY\":0,\"selectable\":true,\"hasControls\":true,\"path\":[[\"M\",859.8514334802995,549.0414340605711],[\"Q\",859.8544334802996,549.0414340605711,860.8547367438823,549.0414340605711],[\"Q\",861.855040007465,549.0414340605711,862.8553432710478,549.0414340605711],[\"Q\",863.8556465346304,549.0414340605711,864.8559497982131,549.0414340605711],[\"Q\",865.8562530617959,549.0414340605711,866.8565563253785,549.0414340605711],[\"Q\",867.8568595889612,549.0414340605711,860.8547367438823,549.0414340605711],[\"Q\",853.8526138988034,549.0414340605711,847.8507943173071,549.0414340605711],[\"Q\",841.8489747358108,549.0414340605711,844.849884526559,549.0414340605711],[\"Q\",847.8507943173071,549.0414340605711,855.8532204259687,549.0414340605711],[\"Q\",863.8556465346304,549.0414340605711,873.8586791704574,548.0411308329499],[\"Q\",883.8617118062846,547.0408276053287,895.8653509692772,547.0408276053287],[\"Q\",907.8689901322697,547.0408276053287,921.8732358224277,547.0408276053287],[\"Q\",935.8774815125855,547.0408276053287,948.8814239391608,547.0408276053287],[\"Q\",961.885366365736,547.0408276053287,972.8887022651458,547.0408276053287],[\"Q\",983.8920381645555,547.0408276053287,991.8944642732172,547.0408276053287],[\"Q\",999.8968903818788,547.0408276053287,1004.8984066997924,547.0408276053287],[\"L\",1009.902923017706,547.0408276053287]]},{\"type\":\"path\",\"version\":\"5.3.0\",\"originX\":\"left\",\"originY\":\"top\",\"left\":540.6,\"top\":803.62,\"width\":695.87,\"height\":4,\"fill\":null,\"stroke\":\"#000000\",\"strokeWidth\":3,\"strokeDashArray\":null,\"strokeLineCap\":\"round\",\"strokeDashOffset\":0,\"strokeLineJoin\":\"round\",\"strokeUniform\":false,\"strokeMiterLimit\":10,\"scaleX\":1,\"scaleY\":1,\"angle\":0,\"flipX\":false,\"flipY\":false,\"opacity\":1,\"shadow\":null,\"visible\":true,\"backgroundColor\":\"\",\"fillRule\":\"nonzero\",\"paintFirst\":\"fill\",\"globalCompositeOperation\":\"source-over\",\"skewX\":0,\"skewY\":0,\"selectable\":true,\"hasControls\":true,\"path\":[[\"M\",543.7556021881634,805.1190603315912],[\"Q\",543.7586021881634,805.1190603315912,542.7582989245807,805.1190603315912],[\"Q\",541.7579956609981,805.1190603315912,543.7586021881634,805.1190603315912],[\"Q\",545.7592087153289,805.1190603315912,557.7628478783214,805.1190603315912],[\"Q\",569.7664870413139,805.1190603315912,596.7746751580471,805.1190603315912],[\"Q\",623.7828632747802,805.1190603315912,667.7962068724194,805.1190603315912],[\"Q\",711.8095504700586,805.1190603315912,769.8271397578558,805.1190603315912],[\"Q\",827.8447290456529,805.1190603315912,891.8641379149462,805.1190603315912],[\"Q\",955.8835467842397,805.1190603315912,1012.9008328084542,805.1190603315912],[\"Q\",1069.9181188326686,805.1190603315912,1108.9299461123942,805.1190603315912],[\"Q\",1147.9417733921198,805.1190603315912,1172.9493549816875,806.1193635592124],[\"Q\",1197.9569365712553,807.1196667868336,1212.961485524996,807.1196667868336],[\"Q\",1227.9660344787367,807.1196667868336,1232.9675507966504,808.1199700144548],[\"L\",1237.9690671145638,809.1202732420759]]}]}";
      var canvasImage = "canvas.png";
      var fallbackImage = null;
      var fabricCanvas = null, saveTimer = null;
      var originalW = 600, originalH = 800; // defaults
      var editor = document.getElementById('editor');
      var saveStatus = document.getElementById('saveStatus');
      
      try { var saved = localStorage.getItem(STORAGE_KEY); if (saved) { var data = JSON.parse(saved); if (data.content) editor.value = data.content; } } catch(e){}
      
      function scheduleSave() {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(function() {
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ content: editor.value })); saveStatus.textContent = 'saved'; } catch(e){}
        }, 1000);
      }
      editor.addEventListener('input', function() { saveStatus.textContent = 'modified'; scheduleSave(); });
      
      function scaleCanvasToFit() {
        var container = document.getElementById('canvasContainer');
        var wrapper = document.getElementById('canvasWrapper');
        var rect = container.getBoundingClientRect();
        var containerW = rect.width - 20;
        var containerH = rect.height - 20;
        
        if (containerW <= 0 || containerH <= 0) return;
        
        var scaleX = containerW / originalW;
        var scaleY = containerH / originalH;
        var scale = Math.min(scaleX, scaleY, 1); // never scale up beyond 1
        
        wrapper.style.transform = 'scale(' + scale + ')';
      }
      
      function initCanvas() {
        // Get original dimensions from JSON if available
        if (canvasJson) {
          originalW = canvasJson.width || 600;
          originalH = canvasJson.height || 800;
        }
        
        var el = document.getElementById('fabricCanvas');
        el.width = originalW;
        el.height = originalH;
        
        fabricCanvas = new fabric.Canvas('fabricCanvas', { 
          width: originalW, 
          height: originalH, 
          backgroundColor: null 
        });
        fabricCanvas.freeDrawingBrush.width = 3;
        fabricCanvas.freeDrawingBrush.color = '#000000';
        
        if (canvasJson) {
          fabricCanvas.loadFromJSON(canvasJson, function() {
            fabricCanvas.renderAll();
            scaleCanvasToFit();
          });
        } else if (canvasImage || fallbackImage) {
          fabric.Image.fromURL(canvasImage || fallbackImage, function(img) {
            if (!img) return;
            img.set({ left: 0, top: 0, selectable: true });
            fabricCanvas.add(img);
            fabricCanvas.renderAll();
            scaleCanvasToFit();
          }, null, { crossOrigin: 'anonymous' });
        } else {
          scaleCanvasToFit();
        }
      }
      
      document.getElementById('selectBtn').onclick = function() { 
        if(fabricCanvas) { 
          fabricCanvas.isDrawingMode = false; 
          this.classList.add('active'); 
          document.getElementById('drawBtn').classList.remove('active'); 
        } 
      };
      document.getElementById('drawBtn').onclick = function() { 
        if(fabricCanvas) { 
          fabricCanvas.isDrawingMode = true; 
          this.classList.add('active'); 
          document.getElementById('selectBtn').classList.remove('active'); 
        } 
      };
      
      setTimeout(initCanvas, 150);
      
      window.addEventListener('resize', function() {
        scaleCanvasToFit();
      });
    })();
  </script>
</body>
</html>